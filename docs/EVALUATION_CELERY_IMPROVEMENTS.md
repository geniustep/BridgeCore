# ุชูุฑูุฑ ุชูููู ููุชุฑุญุงุช ุชุญุณูู Celery Tasks

**ุงูุชุงุฑูุฎ:** $(date)  
**ุงูููู:** `app/tasks/celery_app.py`

---

## ๐ ููุฎุต ุชูููุฐู

ุชู ุชูููู 7 ููุชุฑุญุงุช ุชุญุณูู ููููุฏ ุงูุญุงูู ูู `celery_app.py`. ุงูุชูุฑูุฑ ููุถุญ:
- โ **ููุชุฑุญุงุช ููุตู ุจูุง ููุชูููุฐ ุงูููุฑู** (ุฃููููุฉ ุนุงููุฉ)
- โ๏ธ **ููุชุฑุญุงุช ุชุญุชุงุฌ ุชูููู ุฅุถุงูู** (ุฃููููุฉ ูุชูุณุทุฉ)
- ๐ **ููุชุฑุญุงุช ุงุฎุชูุงุฑูุฉ** (ุฃููููุฉ ููุฎูุถุฉ)

---

## 1๏ธโฃ ุชูููู ุงูููุท ุงููุนูุงุฑู (Event-Driven Webhooks)

### ุงููุถุน ุงูุญุงูู
- โ ุงูููุฏ ูุณุชุฎุฏู `last_event_id` + `limit` + `has_more` (ููุท ุฌูุฏ)
- โ Periodic polling ูู 30 ุซุงููุฉ ูุน batch processing
- โ๏ธ ูุง ููุฌุฏ ุญูุงูุฉ ูู ุงูุชุฒุงูู ุงููุชุนุฏุฏ

### ุงูุชูููู
**ุงูููุงุกูุฉ:** โ ููุชุงุฒุฉ  
**ุงูุฃุซุฑ:** ูุชูุณุท (ุชุญุณูู ุงูุงุณุชูุฑุงุฑ)  
**ุณูููุฉ ุงูุชูููุฐ:** ูุชูุณุทุฉ

**ุงูุฎูุงุตุฉ:** ุงูููุท ุงูุญุงูู ุฌูุฏุ ููู ูุญุชุงุฌ ุชุญุณููุงุช ูู ุฅุฏุงุฑุฉ ุงูุชุฒุงูู.

---

## 2๏ธโฃ ุชูููู ุนุงู ูููุถุน ุงูุญุงูู

### ุงูููุงุท ุงูุฅูุฌุงุจูุฉ
- โ ุชูุณูู ูุงุถุญ ูููุณุคูููุงุช
- โ ุฅุนุฏุงุฏุงุช Celery ูุนูููุฉ
- โ Beat Schedule ูุชูุงุฒู
- โ ุงุณุชุฎุฏุงู `last_event_id` ููู incremental sync

### ุงูููุงุท ุงูุชู ุชุญุชุงุฌ ุชุญุณูู
- โ๏ธ Bug ูุญุชูู ูู `sync_data` ูุน `bidirectional=True`
- โ๏ธ `run_async` ูุฏ ููุดู ูู ุจุนุถ ุงูุจูุฆุงุช
- โ๏ธ ูุง ููุฌุฏ Lock ูู `sync_odoo_webhook_events`

**ุงูุฎูุงุตุฉ:** ุงูุจููุฉ ุงูุนุงูุฉ ุณูููุฉุ ููู ููุงู ุจุนุถ ุงูุฃุฎุทุงุก ุงููุญุชููุฉ ุงูุชู ูุฌุจ ูุนุงูุฌุชูุง.

---

## 3๏ธโฃ Bug ูุญุชูู ูู `sync_data` ูุน `bidirectional=True` โ๏ธ **ุฃููููุฉ ุนุงููุฉ**

### ุงููุดููุฉ
ูู ุงูุณุทุฑ 302:
```python
reverse_results = run_async(sync_data(...))
```

**ุงูุชุญููู:**
- `sync_data` ูู ุฏุงูุฉ ุนุงุฏูุฉ (ููุณุช async coroutine)
- `run_async` ูุชููุน async coroutine
- ูุฐุง ูุฏ ูุณุจุจ ุฎุทุฃ: `TypeError: A coroutine was expected`

### ุงูุญููู ุงูููุชุฑุญุฉ

#### โ **ุงูุญู (ุฃ) - ุงุณุชุฏุนุงุก ุฏุงุฎูู ูุจุงุดุฑ** (ููุตู ุจู)
```python
if bidirectional:
    reverse_results = sync_data(
        user_id=user_id,
        source_system_id=target_system_id,
        target_system_id=source_system_id,
        model=model,
        filters=filters,
        bidirectional=False,
    )
    results["reverse"] = reverse_results
```

**ุงููููุฒุงุช:**
- โ ุจุณูุท ูุขูู
- โ ูุญุงูุธ ุนูู ุงููุชูุฌุฉ ูู ููุณ ุงูุฑุฏ
- โ ูุง ูุญุชุงุฌ ุชุบููุฑุงุช ูุนูุงุฑูุฉ

**ุงูุนููุจ:**
- โ๏ธ ูุนูู ุจุดูู ูุชุฒุงูู (ูุฏ ูููู ุฃุจุทุฃ)

#### โ๏ธ **ุงูุญู (ุจ) - ุฅุทูุงู Task ูุณุชููุฉ** (ูุญุชุงุฌ ุชูููู)
```python
if bidirectional:
    sync_data.delay(
        user_id=user_id,
        source_system_id=target_system_id,
        target_system_id=source_system_id,
        model=model,
        filters=filters,
        bidirectional=False,
    )
```

**ุงููููุฒุงุช:**
- โ ูุนูู ุจุดูู ุบูุฑ ูุชุฒุงูู (ุฃุณุฑุน)
- โ ูุง ููุชุธุฑ ุงููุชูุฌุฉ

**ุงูุนููุจ:**
- โ๏ธ ูุง ูุญุตู ุนูู ูุชูุฌุฉ ุงูุงุชุฌุงู ุงูุนูุณู ูู ููุณ ุงูุฑุฏ
- โ๏ธ ูุญุชุงุฌ ุชุบููุฑ ูู API response

### ุงูุชูุตูุฉ
**โ ุชุทุจูู ุงูุญู (ุฃ) ููุฑุงู** - ูุฐุง Bug ูุญุชูู ูุฌุจ ุฅุตูุงุญู.

---

## 4๏ธโฃ ุชุญุณูู ุฃูุงู `run_async` โ๏ธ **ุฃููููุฉ ุนุงููุฉ**

### ุงููุดููุฉ
ุงููุณุฎุฉ ุงูุญุงููุฉ:
```python
def run_async(coro):
    loop = asyncio.get_event_loop()
    return loop.run_until_complete(coro)
```

**ุงููุดุงูู ุงููุญุชููุฉ:**
- โ ูุฏ ููุดู ุฅุฐุง ูู ููู ููุงู event loop ูุดุท
- โ ูู Python 3.10+ ูุฏ ูุณุจุจ `RuntimeError` ูู ุจุนุถ ุงูุจูุฆุงุช

### ุงูุญู ุงูููุชุฑุญ
```python
def run_async(coro):
    """
    Helper to run async functions in sync Celery tasks
    
    Args:
        coro: Async coroutine
        
    Returns:
        Result of coroutine
    """
    try:
        loop = asyncio.get_event_loop()
    except RuntimeError:
        loop = asyncio.new_event_loop()
        asyncio.set_event_loop(loop)
    return loop.run_until_complete(coro)
```

### ุงูุชูููู
**ุงูููุงุกูุฉ:** โ ููุชุงุฒุฉ  
**ุงูุฃุซุฑ:** ุนุงูู (ููุน ุฃุฎุทุงุก ูุญุชููุฉ)  
**ุณูููุฉ ุงูุชูููุฐ:** ุณููุฉ ุฌุฏุงู

### ุงูุชูุตูุฉ
**โ ุชุทุจูู ููุฑุงู** - ุชุญุณูู ุจุณูุท ููู ููู ููุงุณุชูุฑุงุฑ.

---

## 5๏ธโฃ Lock ูู `sync_odoo_webhook_events` โ๏ธ **ุฃููููุฉ ูุชูุณุทุฉ**

### ุงููุดููุฉ
- โ๏ธ ูู ุงููููู ุฃู ุชุนูู ุฃูุซุฑ ูู ูุณุฎุฉ ูู ููุณ ุงูู task ูู ููุช ูุงุญุฏ
- โ๏ธ ูุฏ ูุณุจุจ ุชุถุงุฑุจ ูู ูุฑุงุกุฉ/ูุชุงุจุฉ `last_event_id`
- โ๏ธ ูุฏ ูุถุบุท ุนูู Odoo ูุงูู Redis

### ุงูุญู ุงูููุชุฑุญ
ุฅุถุงูุฉ Redis Lock ุจุณูุท:

```python
from contextlib import contextmanager
import redis

@contextmanager
def redis_lock(name: str, ttl: int = 60):
    r = redis.from_url(settings.REDIS_URL)
    acquired = r.set(name, "1", nx=True, ex=ttl)
    try:
        if acquired:
            yield True
        else:
            yield False
    finally:
        if acquired:
            r.delete(name)
```

### ุงูุชูููู
**ุงูููุงุกูุฉ:** โ ุฌูุฏุฉ  
**ุงูุฃุซุฑ:** ูุชูุณุท (ุชุญุณูู ุงูุงุณุชูุฑุงุฑ)  
**ุณูููุฉ ุงูุชูููุฐ:** ูุชูุณุทุฉ

### ุงูุงุนุชุจุงุฑุงุช
- โ๏ธ ูุฏ ูุจุทุฆ ุงุณุชููุงู ุงูุฃุญุฏุงุซ ูู ุญุงูุงุช ุงูุถุบุท ุงูุนุงูู
- โ๏ธ ูุญุชุงุฌ ูุฑุงูุจุฉ ูู ุจูุฆุฉ ุงูุฅูุชุงุฌ
- โ ูููุน ุงูุชุถุงุฑุจ ุจุดูู ูุนุงู

### ุงูุชูุตูุฉ
**โ๏ธ ุชุทุจูู ูู ุจูุฆุฉ staging ุฃููุงู** - ูุญุชุงุฌ ุงุฎุชุจุงุฑ ูุจู ุงูุฅูุชุงุฌ.

---

## 6๏ธโฃ ุชุญุณูู `cleanup_old_audit_logs` ๐ **ุฃููููุฉ ููุฎูุถุฉ**

### ุงูุชุญุณูู ุงูููุชุฑุญ
```python
deleted = db.query(AuditLog).filter(
    AuditLog.timestamp < cutoff_date
).delete(synchronize_session=False)
```

### ุงูุชูููู
**ุงูููุงุกูุฉ:** โ ุฌูุฏุฉ  
**ุงูุฃุซุฑ:** ููุฎูุถ (ุชุญุณูู ุฃุฏุงุก ุจุณูุท)  
**ุณูููุฉ ุงูุชูููุฐ:** ุณููุฉ ุฌุฏุงู

### ุงูุชูุตูุฉ
**๐ ุชุทุจูู ุงุฎุชูุงุฑู** - ุชุญุณูู ุจุณูุทุ ููู ุงููุงุฆุฏุฉ ูุญุฏูุฏุฉ ููุฌุฏุงูู ุงูุตุบูุฑุฉ.

---

## 7๏ธโฃ ููุงุญุธุงุช ุฅุถุงููุฉ

### ุงุณุชุฎุฏุงู `service.create` ู `service.read`
ุงูููุฏ ูุณุชุฎุฏู `service.create` ู `service.read` ููู ูู `SystemService` ุงูุฏูุงู ูู:
- `create_record` (async)
- `read_records` (async)

**ููุงุญุธุฉ:** ูุฏ ูููู ููุงู wrapper methods ุฃู aliases ูู ูุชู ุงูุนุซูุฑ ุนูููุง. ูููุตุญ ุจุงูุชุญูู ูู ูุฐุง.

---

## ๐ ุฌุฏูู ุงูุฃููููุงุช

| # | ุงูุชุญุณูู | ุงูุฃููููุฉ | ุงูุญุงูุฉ | ุงูุชูุตูุฉ |
|---|---------|----------|--------|----------|
| 1 | ุฅุตูุงุญ Bug ูู `sync_data` + `bidirectional` | ๐ด ุนุงููุฉ | โ ุฌุงูุฒ | **ุชุทุจูู ููุฑุงู** |
| 2 | ุชุญุณูู `run_async` | ๐ด ุนุงููุฉ | โ ุฌุงูุฒ | **ุชุทุจูู ููุฑุงู** |
| 3 | Lock ูู `sync_odoo_webhook_events` | ๐ก ูุชูุณุทุฉ | โ๏ธ ูุญุชุงุฌ ุงุฎุชุจุงุฑ | **ุชุทุจูู ูู staging ุฃููุงู** |
| 4 | ุชุญุณูู `cleanup_old_audit_logs` | ๐ข ููุฎูุถุฉ | ๐ ุงุฎุชูุงุฑู | **ุชุทุจูู ุนูุฏ ุงูุญุงุฌุฉ** |

---

## โ ุฎุทุฉ ุงูุชูููุฐ ุงูููุชุฑุญุฉ

### ุงููุฑุญูุฉ 1: ุฅุตูุงุญุงุช ุญุฑุฌุฉ (ููุฑุงู)
1. โ ุฅุตูุงุญ Bug ูู `sync_data` ูุน `bidirectional=True`
2. โ ุชุญุณูู `run_async` ููุนุงูุฌุฉ event loop ุจุดูู ุฃูุถู

### ุงููุฑุญูุฉ 2: ุชุญุณููุงุช ุงูุงุณุชูุฑุงุฑ (ุจุนุฏ ุงูุงุฎุชุจุงุฑ)
3. โ๏ธ ุฅุถุงูุฉ Lock ูู `sync_odoo_webhook_events` (ูู staging ุฃููุงู)

### ุงููุฑุญูุฉ 3: ุชุญุณููุงุช ุงุฎุชูุงุฑูุฉ
4. ๐ ุชุญุณูู `cleanup_old_audit_logs` (ุนูุฏ ุงูุญุงุฌุฉ)

---

## ๐ ููุงุญุธุงุช ููุงุฆูุฉ

- ุฌููุน ุงูุชุญุณููุงุช ุงูููุตู ุจูุง ุขููุฉ ููุง ุชุบูุฑ ุงูุณููู ุงูุฃุณุงุณู
- ูููุตุญ ุจุงุฎุชุจุงุฑ ูู ุชุญุณูู ูู ุจูุฆุฉ staging ูุจู ุงูุฅูุชุงุฌ
- ูุฑุงูุจุฉ ุงูุฃุฏุงุก ุจุนุฏ ูู ุชุบููุฑ ูููุฉ

---

**ุชู ุงูุชูููู ุจูุงุณุทุฉ:** AI Assistant  
**ุงูุชุงุฑูุฎ:** $(date)

