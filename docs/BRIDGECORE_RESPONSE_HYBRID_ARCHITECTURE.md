# โ ุฑุฏ ูุฑูู BridgeCore ุนูู ุงูููุท ุงููุนูุงุฑู ุงูููุชุฑุญ

**ุงูุชุงุฑูุฎ:** $(date)  
**ูู:** ูุฑูู BridgeCore  
**ุฅูู:** ูุฑูู Odoo / auto-webhook-odoo

---

## ุงูุณูุงู ุนูููู ูุฑุญูุฉ ุงููู ูุจุฑูุงุชู ๐

ุดูุฑุงู ููู ุนูู ุงูุชูุงุตู ูุงูุชูุณูู. ุจุนุฏ ูุฑุงุฌุนุฉ ุดุงููุฉ ููููุฏ ุงูุญุงูู ูุงูุจููุฉ ุงููุนูุงุฑูุฉุ ูุคูุฏ ููุงููุชูุง ุงููุงููุฉ ุนูู ุงูููุท ุงูููุชุฑุญ **Hybrid (Pull + Push)** ูุน ุจุนุถ ุงูุชูุถูุญุงุช ูุงูุชูุตูุงุช.

---

## โ ุชุฃููุฏ ุงูููุท ุงููุนูุงุฑู

### ูุนูุ ุงูููุท Hybrid ููุงุณุจ ุชูุงูุงู โ

ูุคูุฏ ุฃู ุงูููุท ุงูููุชุฑุญ **Event-Driven Webhooks + Celery Queue + Limits** ุจูุณุฎุฉ **Hybrid (Pull + Push)** ููุงุณุจ ุชูุงูุงู ููุนูุงุฑูุฉ BridgeCore ุงูุญุงููุฉุ ููุญู ุฌุงูุฒูู ูุฏุนูู ุจุงููุงูู.

---

## ๐ ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุงููุทุฑูุญุฉ

### 1๏ธโฃ ุนูู ูุณุชูู BridgeCore / Webhook

#### โ **1. Push Endpoint - ุฌุงูุฒ ููุชููุฑ**

**ุงูุฎุจุฑ ุงูุณุงุฑ:** BridgeCore ูุฏูู ุจุงููุนู endpoint `/api/v1/webhooks/receive` **ุฌุงูุฒ ููุนูู** โ

**ุงููููุน:** `POST /api/v1/webhooks/receive`

**ุงูููุงุตูุงุช ุงูุญุงููุฉ:**
- โ **Authentication:** ูุฏุนู Bearer Token ู API Key (X-API-Key header)
- โ **Rate Limiting:** 200 requests/minute
- โ **Payload:** ูุฏุนู `WebhookReceivePayload` ูุน ุงูุญููู ุงูุชุงููุฉ:
  - `model` (required)
  - `record_id` (required)
  - `event` (required: create/write/unlink)
  - `priority` (optional: high/medium/low)
  - `timestamp` (optional)
  - `payload` (optional: JSON data)
  - `_webhook_metadata` (optional: metadata from Odoo)

**ุงูููุฏ ุงูุญุงูู:**
```python
# BridgeCore/app/modules/webhook/router.py
@router.post("/receive")
async def receive_webhook(
    payload: WebhookReceivePayload,
    _: bool = Depends(verify_webhook_auth)
):
    # Process webhook immediately
    result = await service.receive_webhook(payload.dict())
    return WebhookReceiveResponse(...)
```

**ููุงุญุธุฉ:** ุญุงููุงู ุงูู endpoint ูุนุงูุฌ ุงูุฃุญุฏุงุซ ูุจุงุดุฑุฉ (synchronous). ูููููุง ุจุณูููุฉ ุชุญูููู ููุฏูุน ุงูุฃุญุฏุงุซ ุฅูู Celery Queue ุจุฏูุงู ูู ุงููุนุงูุฌุฉ ุงููุจุงุดุฑุฉ.

---

#### โ **2. ุงุณุชูุฑุงุฑ Pull ููุฃุญุฏุงุซ ุงูุนุงุฏูุฉ**

**ูุนูุ ูุคูุฏ:** โ

- โ ูุณุชูุฑ ูู ุงุณุชุฎุฏุงู `sync_odoo_webhook_events` ููุฃุญุฏุงุซ ุงูุนุงุฏูุฉ (normal priority)
- โ ุงููุธุงู ุงูุญุงูู ูุนูู ุจุดูู ููุชุงุฒ ูุน:
  - `last_event_id` ููู incremental sync
  - `limit` ููู batch processing
  - `has_more` ูุฅุทูุงู sync ุฅุถุงูู ุชููุงุฆูุงู
  - Redis Lock ูููุน ุงูุชุฒุงูู ุงููุชุนุฏุฏ

**ูุง ูุฑู ุฃู ูุดููุฉ ูู ุงูุงุณุชูุฑุงุฑ ุจูุฐุง ุงูููุฌ** โ

---

#### โ **3. ุฅุถุงูุฉ Push ููุฃุญุฏุงุซ ุงูุญุฑุฌุฉ ููุท**

**ูุนูุ ููุงุณุจ ุชูุงูุงู** โ

**ุงูุชูุตูุฉ:**
- โ Push ููุฃุญุฏุงุซ ุงูุญุฑุฌุฉ (priority=high + instant_send=True) ููุท
- โ Pull ููุฃุญุฏุงุซ ุงูุนุงุฏูุฉ (normal/medium/low priority)
- โ ูุฐุง ูููุฑ:
  - Real-time ููุฃุญุฏุงุซ ุงูุญุฑุฌุฉ
  - ุชูููุฑ ููุงุฑุฏ ููุฃุญุฏุงุซ ุงูุนุงุฏูุฉ
  - ูุฑููุฉ ุนุงููุฉ

---

#### โ **4. ุงุณุชุนูุงู Redis Lock**

**ูุนูุ ููุงุณุจ ููุทุจู ุญุงููุงู** โ

**ุงููุถุน ุงูุญุงูู:**
- โ Redis Lock ูุทุจู ูู `sync_odoo_webhook_events` ูููุน ุงูุชุฒุงูู ุงููุชุนุฏุฏ
- โ Lock TTL: 60 ุซุงููุฉ (ูุงุจู ููุชุนุฏูู)
- โ Lock name: `odoo_sync:lock`

**ุงูุชูุตูุฉ:**
- โ ูููู ุฅุถุงูุฉ Lock ุนูู Push endpoint ุฃูุถุงู (ุงุฎุชูุงุฑู)
- โ ุฃู ุงูุงุนุชูุงุฏ ุนูู Celery concurrency limits ููุท

**ุงูููุฏ ุงูุญุงูู:**
```python
# BridgeCore/app/tasks/celery_app.py
@contextmanager
def redis_lock(name: str, ttl: int = 60):
    r = redis.from_url(settings.REDIS_URL)
    acquired = r.set(name, "1", nx=True, ex=ttl)
    try:
        yield acquired
    finally:
        if acquired:
            r.delete(name)
```

---

### 2๏ธโฃ ุนูู ูุณุชูู Odoo (ูุง ูุญุชุงุฌ ุชุฃููุฏู)

#### โ **1. ุฌุฏูู `update.webhook` ููุตุฏุฑ ุฃุณุงุณู**

**ุงูุณุคุงู:** ูู ูููููุง ุงูุงุนุชูุงุฏ ุนูู `update.webhook` ูู ูุตุฏุฑ ุฃุณุงุณู ููู ุงูุฃุญุฏุงุซุ

**ุงูุชุฃููุฏ ุงููุทููุจ:**
- โ ูู ุฌููุน ุงูุฃุญุฏุงุซ ุชูุณุฌูู ูู `update.webhook` ุฏุงุฆูุงู (ุญุชู ุงูุฃุญุฏุงุซ ุงูุญุฑุฌุฉ)?
- โ ูู ุงูู Pull-based system ููููู ุงูุงุนุชูุงุฏ ุนูู `update.webhook` ูู source of truth?

**ููุงุญุธุฉ ูู BridgeCore:**
- ูุญู ูุนุชูุฏ ุญุงููุงู ุนูู `update.webhook` ููู Pull
- ูุฑูุฏ ุงูุชุฃูุฏ ุฃู ุงูุฃุญุฏุงุซ ุงูุญุฑุฌุฉ ุฃูุถุงู ุชูุณุฌูู ูู `update.webhook` (ุญุชู ูู ุชู Push ููุฑุงู)

---

#### โ **2. ุชุญุฏูุฏ ุงูุฃุญุฏุงุซ ุงูุญุฑุฌุฉ**

**ุงูุณุคุงู:** ูู ูููููุง ุชุญุฏูุฏ ููุน ูู ุงูุฃุญุฏุงุซ ุนูู ุฃููุง "ุญุฑุฌุฉ" (priority=high / instant_send=True)?

**ุงูุชุฃููุฏ ุงููุทููุจ:**
- โ ูุง ูู ุงููุนุงููุฑ ูุชุญุฏูุฏ "ุฃุญุฏุงุซ ุญุฑุฌุฉ"?
  - ูู ุญุณุจ `priority` field ูู `webhook.config`?
  - ูู ุญุณุจ `instant_send` flag?
  - ูู ูููู ุชุฎุตูุตูุง ููู model?
- โ ูุง ูู ุงูููุงุฐุฌ ุงูุชู ุชุญุชุงุฌ Push ููุฑู?
  - ูุซูุงู: `sale.order` ุนูุฏ ุชุบููุฑ `state`?
  - ูุซูุงู: `account.payment` ุนูุฏ `confirm`?

**ุงูุชูุตูุฉ ูู BridgeCore:**
- ููุตู ุจูุนูุงุฑ ูุงุถุญ ูุซู:
  ```python
  if config.priority == 'high' and config.instant_send == True:
      # Push immediately
  else:
      # Store only (Pull later)
  ```

---

#### โ **3. ุงููููุฏ ุงูุชูููุฉ**

**ุงูุณุคุงู:** ูุง ูู ุงููููุฏ ุงูุชูููุฉ ุนูุฏููุ

**ูุง ูุญุชุงุฌ ูุนุฑูุชู:**

1. **ุนุฏุฏ ุงูุฃุญุฏุงุซ ุงููุชููุนุฉ:**
   - โ ูู ุนุฏุฏ ุงูุฃุญุฏุงุซ ุงููุชููุนุฉ ูู ุงูุซุงููุฉ (peak load)?
   - โ ูู ุนุฏุฏ ุงูุฃุญุฏุงุซ ุงูุญุฑุฌุฉ ุงููุชููุนุฉ ูู ุงูุซุงููุฉ?

2. **ุงูุฃุฏุงุก ุนูู Odoo:**
   - โ ูู Odoo ููููู ุงูุชุนุงูู ูุน Push ููุฑู ููุฃุญุฏุงุซ ุงูุญุฑุฌุฉ?
   - โ ูุง ูู ูููุฏ ุงูุฃุฏุงุก ุนูู Odoo (CPU / DB) ุนูุฏ ุชูุนูู Push ุฌุฒุฆู?
   - โ ูู ููุงู ูููุฏ ุนูู ุนุฏุฏ ุงูู HTTP requests ูู ุงูุซุงููุฉ?

3. **Retry Logic:**
   - โ ุฅุฐุง BridgeCore ุบูุฑ ูุชุงุญุ ููู ูุชู ุงูุชุนุงูู?
   - โ ูู Odoo ูุฏูู retry mechanism ููู Push?
   - โ ูุง ูู ุงุณุชุฑุงุชูุฌูุฉ Retry (exponential backoff, max retries, timeout)?

---

## ๐ ุงูุชุนุฏููุงุช ุงููุทููุจุฉ ูู BridgeCore

### 1. ุชุญููู Push Endpoint ุฅูู Async (Celery Queue)

**ุงูุญุงูุฉ ุงูุญุงููุฉ:**
- Push endpoint ูุนุงูุฌ ุงูุฃุญุฏุงุซ ูุจุงุดุฑุฉ (synchronous)

**ุงูุชุนุฏูู ุงููุทููุจ:**
- ุชุญููู ุงููุนุงูุฌุฉ ุฅูู Celery Task
- Push endpoint ูุฏูุน ุงูุญุฏุซ ุฅูู Queue ููุนูุฏ 200 OK ููุฑุงู

**ุงูููุฏ ุงูููุชุฑุญ:**
```python
# BridgeCore/app/modules/webhook/router.py
@router.post("/receive")
async def receive_webhook(
    payload: WebhookReceivePayload,
    _: bool = Depends(verify_webhook_auth)
):
    # Push to Celery Queue (async processing)
    process_odoo_webhook_event.delay(payload.dict())
    return {"success": True, "message": "Event queued for processing"}
```

**Celery Task:**
```python
# BridgeCore/app/tasks/celery_app.py
@celery_app.task(name="app.tasks.celery_app.process_odoo_webhook_event")
def process_odoo_webhook_event(payload: dict):
    # Process webhook event in background
    # - Store event locally
    # - Update sync states
    # - Trigger notifications
    pass
```

**ุงูุฃููููุฉ:** ๐ด ุนุงููุฉ (ูุฌุจ ุชุทุจููู ูุจู ุชูุนูู Push)

---

### 2. ุฅุถุงูุฉ Deduplication (ุงุฎุชูุงุฑู)

**ุงูุบุฑุถ:** ููุน ูุนุงูุฌุฉ ููุณ ุงูุญุฏุซ ูุฑุชูู (ุฅุฐุง ูุตู Push ู Pull)

**ุงูุญู ุงูููุชุฑุญ:**
- ุงุณุชุฎุฏุงู `event_id` ูู Odoo ููุชุญูู ูู ุงูุชูุฑุงุฑ
- Redis Set ูุชุฎุฒูู ุงูุฃุญุฏุงุซ ุงููุนุงูุฌุฉ ูุคุฎุฑุงู

**ุงูุฃููููุฉ:** ๐ก ูุชูุณุทุฉ (ูููู ุชุทุจููู ูุงุญูุงู)

---

### 3. ุฅุถุงูุฉ Dead-Letter Queue (ุงุฎุชูุงุฑู)

**ุงูุบุฑุถ:** ุชุฎุฒูู ุงูุฃุญุฏุงุซ ุงููุงุดูุฉ ูููุนุงูุฌุฉ ูุงุญูุงู

**ุงูุฃููููุฉ:** ๐ข ููุฎูุถุฉ (ูููู ุชุทุจููู ูุงุญูุงู)

---

## ๐ ุงูุฃููููุงุช ุงูููุชุฑุญุฉ

### ุงููุฑุญูุฉ 1: ุงูุชุญุถูุฑ (ุฃุณุจูุน 1-2)

#### ูู BridgeCore:
1. โ **ุชุญููู Push endpoint ุฅูู Celery Queue** (ุฃููููุฉ ุนุงููุฉ)
   - ุชุนุฏูู `/api/v1/webhooks/receive` ููุฏูุน ุฅูู Queue
   - ุฅูุดุงุก Celery Task `process_odoo_webhook_event`
   - ุฅุถุงูุฉ error handling ู logging

2. โ **ุชุฃููุฏ Authentication**
   - Bearer Token: `Authorization: Bearer {token}`
   - API Key: `X-API-Key: {api_key}`
   - ุชุฃููุฏ ุขููุฉ ุงููุตุงุฏูุฉ ูุน Odoo

#### ูู Odoo:
1. โ **ุชุญุฏูุฏ ูุนุงููุฑ ุงูุฃุญุฏุงุซ ุงูุญุฑุฌุฉ**
   - ุชุญุฏูุฏ ุงูููุงุฐุฌ ุงูุชู ุชุญุชุงุฌ Push ููุฑู
   - ุชุญุฏูุฏ ูุนุงููุฑ `priority` ู `instant_send`

2. โ **ุฅุนุฏุงุฏ Retry Mechanism**
   - ุงุณุชุฑุงุชูุฌูุฉ Retry (exponential backoff)
   - Max retries ู timeout
   - Dead-letter handling

---

### ุงููุฑุญูุฉ 2: ุงูุงุฎุชุจุงุฑ (ุฃุณุจูุน 3)

1. โ **ุงุฎุชุจุงุฑ Push ููุฃุญุฏุงุซ ุงูุญุฑุฌุฉ**
   - ุงุฎุชุจุงุฑ ูู Staging environment
   - ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูุงูุงุณุชูุฑุงุฑ

2. โ **ุงุฎุชุจุงุฑ Pull ููุฃุญุฏุงุซ ุงูุนุงุฏูุฉ**
   - ุงูุชุฃูุฏ ุฃู Pull ูุนูู ุจุดูู ุทุจูุนู
   - ุงูุชุฃูุฏ ูู ุนุฏู ุงูุชูุฑุงุฑ

3. โ **ุงุฎุชุจุงุฑ Retry Mechanism**
   - ูุญุงูุงุฉ ูุดู BridgeCore
   - ุงูุชุฃูุฏ ูู Retry ูุนูู ุจุดูู ุตุญูุญ

---

### ุงููุฑุญูุฉ 3: ุงูุฅูุชุงุฌ (ุชุฏุฑูุฌู)

1. โ **ุชูุนูู Push ููุฃุญุฏุงุซ ุงูุญุฑุฌุฉ ููุท**
   - Rollout ุชุฏุฑูุฌู
   - ูุฑุงูุจุฉ ุงูุฃุฏุงุก

2. โ **ูุฑุงูุจุฉ ู ุชุญุณูู**
   - ูุฑุงูุจุฉ ุงูุฃุฏุงุก
   - ุชุญุณููุงุช ุญุณุจ ุงูุญุงุฌุฉ

---

## โ๏ธ ููุงุญุธุงุช ุชูููุฉ ูููุฉ

### 1. Deduplication

**ุงููุดููุฉ ุงููุญุชููุฉ:**
- ุฅุฐุง ูุตู ููุณ ุงูุญุฏุซ ูุฑุชูู (Push + Pull)ุ ูุฏ ูุชู ูุนุงูุฌุชู ูุฑุชูู

**ุงูุญู ุงูููุชุฑุญ:**
- ุงุณุชุฎุฏุงู `event_id` ูู Odoo ููุชุญูู
- Redis Set ูุชุฎุฒูู ุงูุฃุญุฏุงุซ ุงููุนุงูุฌุฉ ูุคุฎุฑุงู (TTL: 1 ุณุงุนุฉ)

**ุงูุฃููููุฉ:** ๐ก ูุชูุณุทุฉ

---

### 2. Rate Limiting

**ุงููุถุน ุงูุญุงูู:**
- Push endpoint: 200 requests/minute

**ุงูุชูุตูุฉ:**
- ูุฑุงูุจุฉ ุงูุฃุฏุงุก ูู ุงูุฅูุชุงุฌ
- ุชุนุฏูู Rate Limit ุญุณุจ ุงูุญุงุฌุฉ

---

### 3. Error Handling

**ุงููุถุน ุงูุญุงูู:**
- Push endpoint ูุนูุฏ 200 OK ุญุชู ูู ูุดูุช ุงููุนุงูุฌุฉ (ูุฃููุง async)

**ุงูุชูุตูุฉ:**
- ุฅุถุงูุฉ monitoring ู alerting ููุฃุญุฏุงุซ ุงููุงุดูุฉ
- Dead-letter queue ููุฃุญุฏุงุซ ุงููุงุดูุฉ

---

## โ ุงูุฎูุงุตุฉ

### ุชุฃููุฏุงุช ูู BridgeCore:

1. โ **ุงูููุท Hybrid ููุงุณุจ ุชูุงูุงู** - ูุคูุฏ ุงูููุงููุฉ ุงููุงููุฉ
2. โ **Push endpoint ุฌุงูุฒ** - `/api/v1/webhooks/receive` ููุฌูุฏ ููุนูู
3. โ **Pull system ูุณุชูุฑ** - ูุณุชูุฑ ูู ุงุณุชุฎุฏุงูู ููุฃุญุฏุงุซ ุงูุนุงุฏูุฉ
4. โ **Redis Lock ููุงุณุจ** - ูุทุจู ุญุงููุงู ููููู ุงุณุชุฎุฏุงูู ููู Push ุฃูุถุงู
5. โ **Celery Queue ุฌุงูุฒ** - ุงูุจููุฉ ุงูุชุญุชูุฉ ููุฌูุฏุฉ

### ูุง ูุญุชุงุฌ ุชุฃููุฏู ูู Odoo:

1. โ **ูุนุงููุฑ ุงูุฃุญุฏุงุซ ุงูุญุฑุฌุฉ** - ูุง ูู ุงููุนุงููุฑ ูุชุญุฏูุฏ "ุฃุญุฏุงุซ ุญุฑุฌุฉ"?
2. โ **ุงููููุฏ ุงูุชูููุฉ** - ุนุฏุฏ ุงูุฃุญุฏุงุซ ุงููุชููุนุฉุ ูููุฏ ุงูุฃุฏุงุกุ Retry mechanism
3. โ **ุฌุฏูู `update.webhook`** - ูู ุฌููุน ุงูุฃุญุฏุงุซ ุชูุณุฌูู ููู (ุญุชู ุงูุญุฑุฌุฉ)?

---

## ๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ

### ููุฑุงู (ูุฐุง ุงูุฃุณุจูุน):

1. **BridgeCore:**
   - โ ุชุญููู Push endpoint ุฅูู Celery Queue
   - โ ุฅุถุงูุฉ Celery Task `process_odoo_webhook_event`
   - โ ุฅุถุงูุฉ error handling ู logging

2. **Odoo:**
   - โ ุชุญุฏูุฏ ูุนุงููุฑ ุงูุฃุญุฏุงุซ ุงูุญุฑุฌุฉ
   - โ ุฅุนุฏุงุฏ Retry mechanism
   - โ ุงูุฅุฌุงุจุฉ ุนูู ุงูุฃุณุฆูุฉ ุงููุทุฑูุญุฉ

### ูุฑูุจุงู (ุงูุฃุณุจูุน ุงููุงุฏู):

1. โ ุงุฎุชุจุงุฑ ูู Staging
2. โ ูุฑุงูุจุฉ ุงูุฃุฏุงุก
3. โ ุชุญุณููุงุช ุญุณุจ ุงูุญุงุฌุฉ

---

## ๐ ุงูุชูุงุตู

ูุฃู ุงุณุชูุณุงุฑุงุช ุฃู ุชูุถูุญุงุชุ ูุญู ุฌุงูุฒูู ููุชูุงุตู ูุงูุชูุณูู.

**ุดูุฑุงู ููู** ๐ฑ

---

**ุชู ุฅุนุฏุงุฏ ุงูุฑุฏ ุจูุงุณุทุฉ:** ูุฑูู BridgeCore  
**ุงูุชุงุฑูุฎ:** $(date)  
**ุงูุญุงูุฉ:** โ ุฌุงูุฒ ููุชูููุฐ ุจุนุฏ ุชุฃููุฏ ูู Odoo

